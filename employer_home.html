<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Work-i-Go Employer Home</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#f95f06",
        "background-light": "#f8f6f5",
        "background-dark": "#23160f",
      },
      fontFamily: {
        display: ["Plus Jakarta Sans", "sans-serif"]
      }
    }
  }
}
</script>

<style>
.material-symbols-outlined {
  font-size: 24px;
}
body {
  min-height: max(884px, 100dvh);
}
</style>
</head>

<body class="bg-background-light font-display">
<div class="relative mx-auto min-h-screen w-full max-w-md bg-white overflow-x-hidden pb-24">

<!-- Top Bar -->
<!-- ===== TOP BAR ===== -->
        <div class="sticky top-0 z-10 flex items-center gap-3 bg-white px-4 py-3 shadow-sm">

            <!-- Store Image -->
            <div id="store_image"
                class="h-11 w-11 rounded-full bg-gray-200 bg-cover bg-center flex items-center justify-center">
            </div>

            <!-- Greeting -->
            <div class="flex flex-col leading-tight">
                <span class="text-xs text-gray-400">Welcome üëã</span>
                <h2 id="greeting" class="text-lg font-bold text-gray-900 tracking-tight">
                    Loading...
                </h2>
            </div>

            <!-- Spacer -->
            <div class="flex-1"></div>

            <!-- Chat Icon -->
            <span class="material-symbols-outlined text-gray-600">
                chat_bubble

            </span>

        </div>

<!-- CONTENT -->
<div class="flex-grow overflow-y-auto">

<!-- Stats -->
<div class="flex gap-3 p-4">
  <div class="flex-1 bg-gray-50 p-4 rounded-xl border">
    <p class="text-sm text-gray-500">Approved Posts</p>
    <p id="approved-posts" class="text-3xl font-bold text-[#345395]">0</p>
  </div>
  <div class="flex-1 bg-gray-50 p-4 rounded-xl border">
    <p class="text-sm text-gray-500">Applicants</p>
    <p id="total-applicants" class="text-3xl font-bold text-[#345395]">0</p>
  </div>
</div>

<!-- CTA -->
<div class="px-4">
  <button id="createJobBtn"
    class="w-full h-14 bg-primary text-white rounded-xl font-bold flex items-center justify-center gap-2">
    <span class="material-symbols-outlined">add_circle</span>
    Post a New Job
  </button>
</div>

<!-- Recent Applicants -->
<div class="px-4 pt-6 pb-2 flex justify-between">
  <h2 class="text-[22px] font-bold text-[#345395]">Recent Applicants</h2>
</div>
<div id="recent-applicants" class="px-4 space-y-2"></div>

<!-- My Job Posts -->
<div class="px-4 pt-8 pb-2 flex justify-between">
  <h2 class="text-[22px] font-bold text-[#345395]">My Job Posts</h2>
</div>
<div id="my-job-posts" class="px-4 space-y-2"></div>

</div>

<!-- Bottom Nav -->
<div class="fixed bottom-0 left-0 right-0 bg-white border-t">
  <div class="flex h-20 justify-around items-center">
    <span class="material-symbols-outlined text-primary">home</span>
    <span class="material-symbols-outlined">group</span>
    <span class="material-symbols-outlined">calendar_month</span>
    <span class="material-symbols-outlined">person</span>
  </div>
</div>

</div>

<!-- ================= SUPABASE ================= -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://ispbevvwwggbktfczmui.supabase.co",
  "sb_publishable_5pnSaiKllm-q7UNMe5r7pw_n4Qu-AJ7"
);

/* ================= ROUTE FUNCTION ================= */
window.goToJob = function (jobpostId, status) {
  if (status === "Approved") {
    location.href = `AcceptDecline.html?jobpost_id=${jobpostId}`;
  } else {
    location.href = `employer_post_status.html?id=${jobpostId}`;
  }
};


    /* ===============================
       LOAD PROFILE
    =============================== */
    async function loadProfile() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "signin.html";
        return;
      }
      

      const { data: employer } = await supabase
        .from("employers")
        .select("business_name, store_image_url")
        .eq("user_id", user.id)
        .single();

      document.getElementById("greeting").textContent =
        employer?.business_name || "User";

      const storeImage = document.getElementById("store_image");
      if (employer?.store_image_url) {
        storeImage.style.backgroundImage = `url('${employer.store_image_url}')`;
      } else {
        storeImage.innerHTML = `<span class="material-symbols-outlined text-gray-400">business</span>`;
      }
    }

/* ================= LOAD DASHBOARD ================= */
async function loadDashboard() {
  const { data: { user }, error } = await supabase.auth.getUser();
  if (!user || error) {
    location.href = "signin.html";
    return;
  }

  const employer_id = "EM_" + user.id;

  /* ===== JOB POSTS ===== */
  const { data: jobposts, error: jobErr } = await supabase
    .from("jobposts")
    .select("jobpost_id, job_title, approval_status")
    .eq("employer_id", employer_id)
    .order("created_at", { ascending: false });

  if (jobErr) {
    console.error(jobErr);
    return;
  }

  /* ===== RENDER JOB POSTS ===== */
  const jobContainer = document.getElementById("my-job-posts");
  jobContainer.innerHTML = "";

  jobposts.forEach(job => {
    let badge = "";

    if (job.approval_status === "Approved") {
      badge = `<span class="px-3 py-1 text-xs rounded-full bg-green-100 text-green-700">Approved</span>`;
    } else if (job.approval_status === "Pending") {
      badge = `<span class="px-3 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">Pending</span>`;
    } else {
      badge = `<span class="px-3 py-1 text-xs rounded-full bg-red-100 text-red-700">Rejected</span>`;
    }

    jobContainer.innerHTML += `
      <div
        onclick="goToJob('${job.jobpost_id}', '${job.approval_status}')"
        class="flex items-center gap-4 bg-gray-50 p-4 rounded-xl border cursor-pointer">

        <div class="flex-1">
          <p class="font-medium">${job.job_title}</p>
          <p class="text-sm text-gray-500">
            Status: ${job.approval_status}
          </p>
        </div>

        ${badge}
      </div>
    `;
  });
/* ===== RECENT APPLICANTS ===== */
// 1. ‡∏î‡∏∂‡∏á jobpost_id ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á employer
const { data: myJobs, error: jobErr2 } = await supabase
  .from("jobposts")
  .select("jobpost_id")
  .eq("employer_id", employer_id)

if (jobErr2) {
  console.error(jobErr2)
  return
}

const jobIds = myJobs.map(j => j.jobpost_id)

// ‡∏ñ‡πâ‡∏≤ employer ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ job post
if (jobIds.length === 0) {
  document.getElementById("recent-applicants").innerHTML =
    `<p class="text-sm text-gray-400">No applicants yet</p>`
  return
}

// 2. ‡∏î‡∏∂‡∏á applicants ‡∏à‡∏≤‡∏Å jobpost_id ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
const { data: applicants, error: appErr } = await supabase
  .from("job_applications")
  .select(`
    job_application_id,
    application_status,
    applied_at,
    jobposts (
      job_title
    ),
    job_seekers (
      profiles (
        first_name,
        last_name,
        avatar_url
      )
    )
  `)
  .in("jobpost_id", jobIds)
  .order("applied_at", { ascending: false })
  .limit(5)

if (appErr) {
  console.error(appErr)
  return
}

console.log(applicants[0])

// 3. render
const recentContainer = document.getElementById("recent-applicants")
recentContainer.innerHTML = ""

if (applicants.length === 0) {
  recentContainer.innerHTML =
    `<p class="text-sm text-gray-400">No applicants yet</p>`
}

applicants.forEach(app => {
  const profile = app.job_seekers?.profiles

  const fullName = profile
    ? `${profile.first_name ?? ""} ${profile.last_name ?? ""}`.trim()
    : "Unknown"

  const avatar = profile?.avatar_url

  recentContainer.innerHTML += `
    <div class="flex items-center gap-3 bg-gray-50 border rounded-xl p-4">
      
      <!-- Avatar -->
      <div class="h-12 w-12 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center">
        ${
          avatar
            ? `<img src="${avatar}" class="h-full w-full object-cover" />`
            : `<span class="material-symbols-outlined text-gray-400">person</span>`
        }
      </div>

      <!-- Info -->
      <div class="flex-1">
        <p class="font-medium">${fullName || "Unknown"}</p>
        <p class="text-sm text-gray-500">
          Applied for: ${app.jobposts?.job_title ?? "-"}
        </p>
        <p class="text-xs text-gray-400">
          ${new Date(app.applied_at).toLocaleDateString()}
        </p>
      </div>

    </div>
  `
})

// 4. stats
document.getElementById("total-applicants").innerText = applicants.length
  /* ===== STATS ===== */
  document.getElementById("approved-posts").innerText =
    jobposts.filter(j => j.approval_status === "Approved").length;
}
document
  .getElementById("createJobBtn")
  .addEventListener("click", () => {
    localStorage.removeItem("jobPostDraft");
    location.href = "employer_post_a_job_form.html";
  });
loadProfile();
loadDashboard();
</script>



</body>
</html>
