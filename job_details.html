<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job Details</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <style>
    body {
      font-family: "Plus Jakarta Sans", sans-serif;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
  </style>
</head>

<body class="bg-background-light">
  <div class="relative flex min-h-screen w-full flex-col">

    <!-- ===== TOP BAR ===== -->
    <div class="sticky top-0 z-10 flex items-center gap-3 bg-white px-4 py-3 shadow-sm">
      <button onclick="history.back()" class="size-10">
        <span class="material-symbols-outlined">arrow_back_ios_new</span>
      </button>
      <h2 class="flex-1 text-center text-lg font-bold ">Job Details</h2>
      <div class="size-10"></div>
    </div>

    <main class="flex-1 pb-40">

      <!-- ===== HEADER ===== -->
      <div class="p-4">
        <div class="rounded-xl bg-white p-4 shadow">
          <div class="flex gap-4">
            <div class="h-16 w-16 rounded-xl bg-gray-200 overflow-hidden">
  <img
    id="employer-image"
    class="h-full w-full object-cover hidden"
  />
  <span
    id="employer-placeholder"
    class="material-symbols-outlined text-3xl text-gray-400 flex h-full w-full items-center justify-center"
  >
    store
  </span>
</div>

            <div class="flex-1">
              <p id="job-title" class="text-xl font-bold"></p>
              <p id="workplace-name" class="text-sm text-gray-500"></p>
            </div>
          </div>

          <!-- ค่าแรง -->
          <div class="mt-4 flex justify-end rounded-lg bg-gray-100 p-3">
            <p id="wage-display" class="text-lg font-bold text-emerald-600"></p>
          </div>
        </div>
      </div>

      <!-- ===== DETAIL BLOCKS ===== -->
      <div class="px-4 flex flex-col gap-3">

        <!-- applicants -->
        <div class="flex items-center gap-3 rounded-xl bg-white p-4 shadow-sm">
          <span class="material-symbols-outlined text-blue-500">group</span>
          <p class="text-sm">
            <span id="applicants-count" class="font-bold"></span> applicants
          </p>
        </div>

        <!-- deadline -->
        <div class="flex items-center gap-3 rounded-xl bg-white p-4 shadow-sm">
          <span class="material-symbols-outlined text-red-500">timer</span>
          <p class="text-sm">
            Deadline: <span id="deadline" class="font-bold"></span>
          </p>
        </div>

        <!-- start date + shift time -->
        <div class="flex items-center gap-3 rounded-xl bg-white p-4 shadow-sm">
          <span class="material-symbols-outlined text-purple-500">calendar_month</span>
          <p class="text-sm">
            Start: <span id="start-display" class="font-bold"></span>
          </p>
        </div>

        <!-- location -->
        <div class="flex items-center gap-3 rounded-xl bg-white p-4 shadow-sm">
          <span class="material-symbols-outlined text-emerald-600">location_on</span>
          <p id="address" class="text-sm font-medium"></p>
        </div>

        <!-- workers needed -->
        <div class="flex items-center gap-3 rounded-xl bg-white p-4 shadow-sm">
          <span class="material-symbols-outlined text-orange-500">groups</span>
          <p class="text-sm">
            <span id="workers-needed" class="font-bold"></span> people needed
          </p>
        </div>

      </div>

      <hr class="mx-4 my-6" />

      <!-- ===== AGE REQUIREMENT ===== -->
      <div class="px-4 mt-4">
        <h3 class="text-lg font-bold">Age</h3>
        <p id="age-requirement" class="mt-2 text-gray-600 leading-relaxed"></p>
      </div>

      <!-- ===== GENDER REQUIREMENT ===== -->
      <div class="px-4 mt-4">
        <h3 class="text-lg font-bold">Gender</h3>
        <p id="gender-requirement" class="mt-2 text-gray-600 leading-relaxed"></p>
      </div>

      <!-- ===== DESCRIPTION ===== -->
      <div class="px-4 mt-4">
        <h3 class="text-lg font-bold">Job Description</h3>
        <p id="job-description" class="mt-2 text-gray-600 leading-relaxed"></p>
      </div>

      <!-- ===== QUALIFICATIONS ===== -->
      <div class="px-4 mt-4">
        <h3 class="text-lg font-bold">Qualifications</h3>
        <p id="qualifications" class="mt-2 text-gray-600 leading-relaxed"></p>
      </div>

    </main>

    <!-- ===== APPLY BUTTON ===== -->
    <div class="fixed bottom-20 left-0 w-full px-4"> <button id="apply-button"
        class="h-12 w-full rounded-xl bg-orange-500 text-white font-bold"> Apply Now </button> </div>
  </div>

  <!-- ===== SUPABASE ===== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseClient = window.supabase.createClient(
      "https://ispbevvwwggbktfczmui.supabase.co",
      "sb_publishable_5pnSaiKllm-q7UNMe5r7pw_n4Qu-AJ7"
    );

    const params = new URLSearchParams(window.location.search);
    const jobpostId = params.get("id");

    async function loadJobDetail() {
      const { data, error } = await supabaseClient
        .from("jobposts")
        .select(`
  *,
  employers ( store_image_url ),
  provinces!jobposts_province_id_fkey ( name_th ),
  districts!jobposts_district_id_fkey ( name_th ),
  sub_districts!jobposts_sub_district_id_fkey ( name_th )
`)
        .eq("jobpost_id", jobpostId)
        .single();

      if (error || !data) {
        alert("โหลดข้อมูลงานไม่สำเร็จ");
        return;
      }

      document.getElementById("job-title").textContent = data.job_title ?? "-";
      document.getElementById("workplace-name").textContent = data.workplace_name ?? "-";
      document.getElementById("job-description").textContent = data.job_description ?? "-";
      document.getElementById("qualifications").textContent = data.qualifications ?? "-";
      
      document.getElementById("gender-requirement").textContent = data.gender_requirement ?? "Any";
      document.getElementById("address").textContent = `
        ${data.address ?? ""}
        ต.${data.sub_districts?.name_th ?? "-"}
        อ.${data.districts?.name_th ?? "-"}
        จ.${data.provinces?.name_th ?? "-"}
        `;
      document.getElementById("workers-needed").textContent = data.workers_needed ?? "-";

      
      document.getElementById("deadline").textContent = data.application_deadline ?? "-";


      const { count } = await supabaseClient
    .from("job_applications")
    .select("*", { count: "exact", head: true })
    .eq("jobpost_id", jobpostId);

  document.getElementById("applicants-count").textContent = count ?? 0;
  
      const startDate = data.start_date ?? "-";
      const endDate = data.end_date ?? "-";
      const startTime = data.start_time ?? "-";
      const endTime = data.end_time ?? "-";
      const img = document.getElementById("employer-image");
const placeholder = document.getElementById("employer-placeholder");

if (data.employers?.store_image_url) {
  img.src = data.employers.store_image_url;
  img.classList.remove("hidden");
  placeholder.classList.add("hidden");
}
      document.getElementById("start-display").textContent = `${startDate}-${endDate} | ${startTime} - ${endTime}`;

      document.getElementById("wage-display").textContent =
      data.wage_amount ? `${data.wage_amount} ฿/ชม.` : "-";

      const ageEl = document.getElementById("age-requirement");

if (data.age_requirement?.from && data.age_requirement?.to) {
  ageEl.textContent = `${data.age_requirement.from} – ${data.age_requirement.to} ปี`;
} else if (data.age_requirement?.from) {
  ageEl.textContent = `${data.age_requirement.from} ปีขึ้นไป`;
} else if (data.age_requirement?.to) {
  ageEl.textContent = `ไม่เกิน ${data.age_requirement.to} ปี`;
} else {
  ageEl.textContent = "ไม่ระบุ";
}
    }

    loadJobDetail();

    // ===== APPLY JOB / VIEW STATUS =====
    const applyButton = document.getElementById("apply-button");

    async function checkApplication() {
      if (!jobpostId) return;

      // ดึง user ปัจจุบัน
      const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
      if (!user || authError) return;

      // ดึง job_seeker_id ของ user
      const { data: jobSeeker } = await supabaseClient
        .from("job_seekers")
        .select("job_seeker_id")
        .eq("user_id", user.id)
        .maybeSingle();

      if (!jobSeeker) return;
      // นับจำนวนผู้สมัครงานนี้
const { count, error: countError } = await supabaseClient
  .from("job_applications")
  .select("*", { count: "exact", head: true })
  .eq("jobpost_id", jobpostId);
      // ตรวจสอบว่าผู้ใช้สมัครงานนี้แล้วหรือยัง
      const { data: existingApplication } = await supabaseClient
        .from("job_applications")
        .select("job_application_id")
        .eq("worker_id", jobSeeker.job_seeker_id)
        .eq("jobpost_id", jobpostId)
        .maybeSingle();

      if (existingApplication) {
        // ถ้าเคยสมัครแล้ว เปลี่ยนปุ่ม
        applyButton.textContent = "View Application Status";
        applyButton.classList.add("bg-primary"); // หรือสีอื่นตามต้องการ
        applyButton.onclick = () => {
          window.location.href = "job_application_status_list.html";
        };
      } else {
        // ถ้ายังไม่สมัคร กดสมัครงานได้
        applyButton.textContent = "Apply Now";
        applyButton.classList.remove("bg-primary");
        applyButton.classList.add("bg-orange-500");
        applyButton.onclick = async () => {
          const { error } = await supabaseClient
            .from("job_applications")
            .insert({
              worker_id: jobSeeker.job_seeker_id,
              jobpost_id: jobpostId,
              application_status: "Pending",
              applied_at: new Date().toISOString()
            });
          if (error) {
            alert("ไม่สามารถสมัครงานได้: " + error.message);
            return;
          }
          window.location.href = "application_confirmation.html";
        };
      }
    }

    checkApplication();
  </script>

</body>

</html>
