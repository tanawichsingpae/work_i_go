<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Post Submission Status</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#ff6a00",
        secondary: "#1F3A5F",
        "background-light": "#ffffff",
        "background-dark": "#23170f",
        "card-gray": "#F5F7FA",
        "error-red": "#ef4444"
      },
      fontFamily: {
        display: ["Manrope", "sans-serif"]
      }
    }
  }
}
</script>

<style>
body {
  font-family: 'Manrope', sans-serif;
}
</style>
</head>

<body class="bg-background-light text-[#1d130c] font-display min-h-screen flex flex-col">

<!-- HEADER -->
<header class="sticky top-0 z-50 bg-background-light/80 backdrop-blur border-b">
  <div class="flex items-center p-4 justify-between max-w-lg mx-auto">
    <button onclick="location.href='employer_home.html'"
      class="size-10 flex items-center justify-center rounded-full hover:bg-gray-100">
      <span class="material-symbols-outlined text-secondary">
        arrow_back_ios_new
      </span>
    </button>
    <h2 class="text-secondary text-lg font-bold flex-1 text-center pr-10">
      Post Status
    </h2>
  </div>
</header>

<main class="flex-1 max-w-lg mx-auto w-full pb-32">

<!-- TITLE -->
<section class="px-4 pt-6 pb-2">
  <h3 class="text-secondary text-2xl font-extrabold">
    Post Review Status
  </h3>
  <p class="text-gray-500 text-base mt-1">
    Your post has been reviewed by admin
  </p>
</section>

<!-- STATUS CARD -->
<section class="p-4">
  <div id="status-card"
    class="flex items-center gap-4 rounded-xl p-5 border ios-shadow">
    <div class="flex-1">
      <div class="flex items-center gap-2 mb-1">
        <span id="status-dot"></span>
        <p id="status-label"></p>
      </div>
      <p id="status-title" class="text-xl font-bold"></p>
    </div>
    <div class="bg-white p-3 rounded-full shadow-sm">
      <span id="status-icon" class="material-symbols-outlined"></span>
    </div>
  </div>
</section>

<!-- ADMIN COMMENT -->
<section id="appeal-section" class="px-4 py-2 hidden">
  <div class="rounded-xl bg-secondary p-5 ios-shadow">
    <h4 class="text-white text-sm font-bold uppercase tracking-widest mb-3">
      Admin Feedback
    </h4>
    <p id="appeal-comment"
      class="text-white/90 text-sm italic leading-relaxed"></p>
  </div>
</section>

<!-- VIEW INFO -->
<section id="view-section" class="px-4 py-4">
  <h3 class="text-secondary text-lg font-bold mb-4">
    Post Information
  </h3>

   <div class="mt-4 rounded-2xl bg-card border shadow-sm divide-y">

  <div class="p-5 space-y-3">
    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Job Title</p>
      <p id="job-title" class="font-semibold text-base"></p>
    </div>

    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Description</p>
      <p id="job-description"
        class="text-sm text-gray-700 leading-relaxed whitespace-pre-line"></p>
    </div>
  </div>

  <div class="p-5 grid grid-cols-2 gap-4 text-sm">
    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Workplace</p>
      <p id="workplace-name" class="font-medium"></p>
    </div>
    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Address</p>
      <p id="address" class="font-medium"></p>
    </div>
  </div>

  <div class="p-5 grid grid-cols-3 gap-4 text-sm">
    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Wage</p>
      <p id="wage" class="font-medium"></p>
    </div>
    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Payment</p>
      <p id="payment" class="font-medium"></p>
    </div>
    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Gender</p>
      <p id="gender" class="font-medium"></p>
    </div>
  </div>

  <div class="p-5 grid grid-cols-2 gap-4 text-sm">
    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Date</p>
      <p id="date-range" class="font-medium"></p>
    </div>
    <div>
      <p class="text-xs font-bold text-gray-400 uppercase">Time</p>
      <p id="time-range" class="font-medium"></p>
    </div>
  </div>

  <div class="p-5">
    <p class="text-xs font-bold text-gray-400 uppercase">Contact</p>
    <p id="contact" class="font-medium text-sm"></p>
  </div>
</div>

</section>


<!-- EDIT FORM -->
<section id="edit-section" class="px-4 py-4 hidden">
  <h3 class="text-secondary text-lg font-bold mb-3">
    Edit Job Post
  </h3>

  <div class="space-y-3">
    <input
      id="edit-job-title"
      class="w-full rounded-xl border p-4"
      placeholder="Job title"
    />

    <textarea
      id="edit-job-description"
      rows="6"
      class="w-full rounded-xl border p-4"
      placeholder="Job description"
    ></textarea>

    <button
      id="saveBtn"
      class="w-full bg-primary text-white font-bold py-4 rounded-xl"
    >
      Save & Resubmit
    </button>
  </div>
</section>

</main>

<!-- FOOTER -->
<footer class="fixed bottom-0 left-0 right-0 bg-background-light border-t p-4">
  <button id="editBtn"
  class="hidden w-full bg-primary text-white font-bold py-4 rounded-xl
         flex items-center justify-center gap-2 transition">
  <span id="editBtnIcon" class="material-symbols-outlined">edit_square</span>
  <span id="editBtnText">Appeals used (0/2)</span>
</button>

</footer>

<!-- ================= SUPABASE ================= -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://ispbevvwwggbktfczmui.supabase.co",
  "sb_publishable_5pnSaiKllm-q7UNMe5r7pw_n4Qu-AJ7"
);

/* ---------- PARAM ---------- */
const jobpostId = new URLSearchParams(location.search).get("id");
if (!jobpostId) {
  alert("Missing jobpost id");
  history.back();
}

/* ---------- LOAD DATA ---------- */
const { data, error } = await supabase
  .from("jobposts")
  .select(`
  jobpost_id,
  job_title,
  job_description,
  approval_status,
  appeal_comment,
  qualifications,
  age_requirement,
  gender_requirement,
  wage_amount,
  payment_method,
  workplace_name,
  address,
  start_date,
  start_time,
  end_time,
  end_date,
  contact_name,
  phone_number,
  appeal_count,
  zip_code,

  provinces!jobposts_province_id_fkey(name_th),
  districts!jobposts_district_id_fkey(name_th),
  sub_districts!jobposts_sub_district_id_fkey(name_th)
`)
  .eq("jobpost_id", jobpostId)
  .single();

if (error || !data) {
  alert("Post not found");
  history.back();
}

/* ---------- BIND INFO ---------- */
const set = (id, val) =>
  document.getElementById(id).textContent = val || "-";

set("job-title", data.job_title);
set("job-description", data.job_description);
set("workplace-name", data.workplace_name);
set(
  "address",
  `${data.address || ""} 
  ต.${data.sub_districts?.name_th || "-"} 
  อ.${data.districts?.name_th || "-"} 
  จ.${data.provinces?.name_th || "-"} 
  ${data.zip_code || ""}`
);
set("wage", `${data.wage_amount} บาท / ชม.`);
set("payment", data.payment_method);
set("gender", data.gender_requirement);
set("date-range", `${data.start_date} → ${data.end_date}`);
set("time-range", `${data.start_time} → ${data.end_time}`);
set("contact", `${data.contact_name} (${data.phone_number})`);



/* ---------- STATUS UI ---------- */
const statusCard = document.getElementById("status-card");
const statusDot = document.getElementById("status-dot");
const statusLabel = document.getElementById("status-label");
const statusTitle = document.getElementById("status-title");
const statusIcon = document.getElementById("status-icon");
const appealSection = document.getElementById("appeal-section");
const appealComment = document.getElementById("appeal-comment");
const editBtn = document.getElementById("editBtn");

if (data.approval_status === "Pending") {
  statusCard.classList.add("bg-yellow-50","border-yellow-200");
  statusDot.className = "size-2 rounded-full bg-yellow-500 animate-pulse";
  statusLabel.textContent = "Pending Review";
  statusLabel.className = "text-yellow-600 text-xs font-bold uppercase";
  statusTitle.textContent = "Status: Pending Approval";
  statusIcon.textContent = "hourglass_top";
  statusIcon.className = "material-symbols-outlined text-yellow-500 text-3xl";
}

const maxAppeal = 2;
const editBtnText = document.getElementById("editBtnText");
const editBtnIcon = document.getElementById("editBtnIcon");

if (data.approval_status === "Rejected") {
  statusCard.classList.add("bg-red-50","border-red-200");
  statusDot.className = "size-2 rounded-full bg-error-red animate-pulse";
  statusLabel.textContent = "Rejected";
  statusLabel.className = "text-error-red text-xs font-bold uppercase";
  statusTitle.textContent = "Status: Rejected";
  statusIcon.textContent = "cancel";
  statusIcon.className =
    "material-symbols-outlined text-error-red text-3xl";

  appealSection.classList.remove("hidden");
  appealComment.textContent =
    data.appeal_comment || "No comment from admin.";

  editBtn.classList.remove("hidden");

  // ✅ Show appeal count
  editBtnText.textContent =
    `Appeals used (${data.appeal_count}/${maxAppeal})`;

  // ❌ Appeal limit reached
  if (data.appeal_count >= maxAppeal) {
    editBtn.disabled = true;
    editBtn.classList.remove("bg-primary");
    editBtn.classList.add(
      "bg-gray-300",
      "text-gray-500",
      "cursor-not-allowed"
    );

    editBtnIcon.textContent = "block";
    editBtnText.textContent =
      `Appeal limit reached (${maxAppeal}/${maxAppeal})`;
  }
}


/* ---------- EDIT ---------- */
editBtn.onclick = () => {
  location.href = `employer_post_a_job_form.html?id=${data.jobpost_id}&mode=edit`;
};



</script>

</body>
</html>
