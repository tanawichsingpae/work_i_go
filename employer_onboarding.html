<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employer Onboarding</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#345395",
            accent: "#f95e07",
            background: "#f8f6f5",
          },
          fontFamily: {
            display: ["Plus Jakarta Sans", "sans-serif"]
          }
        }
      }
    }
  </script>
</head>

<body class="bg-background font-display">

<div class="max-w-md mx-auto min-h-screen pb-24">

  <!-- HEADER -->
  <div class="flex items-center gap-3 p-4">
    <span onclick="location.href='select_role.html'"
      class="material-symbols-outlined cursor-pointer">arrow_back_ios_new</span>
    <h2 class="text-lg font-bold">Set Up Your Business</h2>
  </div>

  <!-- IMAGE UPLOAD -->
  <div class="px-4 pb-6">
    <div class="border-2 border-dashed rounded-xl p-6 flex flex-col items-center gap-4">
      <img id="imagePreview"
        src="https://via.placeholder.com/150"
        class="w-32 h-32 rounded-xl object-cover"/>

        <div id="store_image_loading" class="hidden absolute inset-0 bg-black/40 rounded-full
           flex items-center justify-center text-white text-sm font-semibold">
              Uploading...
            </div>

      <label class="cursor-pointer bg-gray-200 px-4 py-2 rounded-lg font-semibold">
        Upload Photo
        <input id="imageInput" type="file" accept="image/*" class="hidden"/>
      </label>
    </div>
  </div>

  <!-- FORM -->
  <div class="px-4 space-y-4">

    <input id="businessName"
      class="w-full rounded-lg border p-3"
      placeholder="Business Name"/>

    <input id="businessType"
      class="w-full rounded-lg border p-3"
      placeholder="Business Type"/>

    <input id="address"
      class="w-full rounded-lg border p-3"
      placeholder="Business Address"/>

    <!-- CONTACT -->
    <div>
      <p class="font-semibold mb-2">Primary Contact Method</p>

      <div class="grid grid-cols-3 gap-2 mb-2">
        <button class="contact-btn bg-white font-bold border rounded-lg py-2"
          data-method="phone">Phone</button>
        <button class="contact-btn border rounded-lg py-2"
          data-method="line">LINE</button>
        <button class="contact-btn border rounded-lg py-2"
          data-method="email">Email</button>
      </div>

      <input id="contactValue"
        class="w-full rounded-lg border p-3"
        placeholder="Enter phone number"/>
    </div>
  </div>

  <!-- SUBMIT -->
  <div class="fixed bottom-0 left-0 right-0 p-4 bg-white">
    <button id="submitBtn"
      class="w-full bg-accent text-white rounded-xl py-3 font-bold">
      Complete Profile
    </button>
  </div>

</div>

<!-- SUPABASE SCRIPT -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://ispbevvwwggbktfczmui.supabase.co",
  "sb_publishable_5pnSaiKllm-q7UNMe5r7pw_n4Qu-AJ7"
)

/* ===== AUTH ===== */
const { data: { user }, error: userError } = await supabase.auth.getUser()
        if (userError || !user) location.href = "signin.html"

/* ===== ELEMENTS ===== */
const imageInput = document.getElementById("imageInput")
const imagePreview = document.getElementById("imagePreview")
const imageLoading = document.getElementById("imageLoading")

const contactInput = document.getElementById("contactValue")

let storeImageFile = null
let contactMethod = "phone"

/* ===== IMAGE PREVIEW ===== */
imageInput.addEventListener("change", () => {
  storeImageFile = imageInput.files[0]
  if (!storeImageFile) return

  imagePreview.src = URL.createObjectURL(storeImageFile)
})
    const submitBtn = document.getElementById("submitBtn")

    /* ===== CONTACT METHOD ===== */
document.querySelectorAll(".contact-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".contact-btn")
      .forEach(b => b.classList.remove("bg-white","font-bold"))

    btn.classList.add("bg-white","font-bold")
    contactMethod = btn.dataset.method

    contactInput.placeholder =
      contactMethod === "phone" ? "Enter phone number" :
      contactMethod === "line" ? "Enter LINE ID" :
      "Enter email"
  })
})

submitBtn.addEventListener("click", async () => {
  submitBtn.disabled = true
  submitBtn.textContent = "Saving..."

  const business_name = document.getElementById("businessName").value.trim()
  const business_type = document.getElementById("businessType").value.trim
  const address = document.getElementById("address").value.trim()
  const contact_value = contactInput.value.trim()
  

  if (!business_name || !business_type || !address || !contact_value) {
    alert("Please fill all required fields")
    submitBtn.disabled = false
    submitBtn.textContent = "Complete Profile"
    return
  }
// ===== UPLOAD AVATAR =====
      let store_image_url = null

      if (storeImageFile) {
        store_image_loading.classList.remove("hidden")

        const ext = storeImageFile.name.split(".").pop()
        const filePath = `${user.id}/store_image.jpg`

        const { error: uploadError } = await supabase.storage
          .from("store_image")
          .upload(filePath, storeImageFile, { upsert: true })

        store_image_loading.classList.add("hidden")

        if (uploadError) {
          alert(uploadError.message)
          submitBtn.disabled = false
          submitBtn.innerText = "Complete Profile"
          return
        }

        store_image_url = supabase.storage
          .from("store_image")
          .getPublicUrl(filePath).data.publicUrl
      }
  // ===== GET employer_id =====

  const { data,error: employerError } = await supabase
    .from("employers")
    .upsert({
      user_id: user.id,
      business_name,
      business_type,
      address,
      contact_method: contactMethod, // ✅ สำคัญ
      contact_value,
      store_image_url
    })
    const { error: profileError } = await supabase
        .from("profiles")
        .update({
          role_id: 1,
          avatar_url: store_image_url
        })
        .eq("id", user.id)

  if (profileError) {
    alert("Profile update error: " + profileError.message)
    submitBtn.disabled = false
    submitBtn.textContent = "Complete Profile"
    return
  }
  if (employerError) {
        alert("Employer save error: " + employerError.message)
        submitBtn.disabled = false
        submitBtn.innerText = "Complete Profile"
        return
      }

  location.href = "employer_home.html"
})

</script>


</body>
</html>
